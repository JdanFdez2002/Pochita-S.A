<div class="card">
    <h2>Citas de hoy</h2>
    <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom:10px;">
        <div class="form-field">
            <label>Veterinario</label>
            <select id="hoy-vet"></select>
        </div>
        <div class="form-field">
            <label>Servicio</label>
            <select id="hoy-servicio"></select>
        </div>
    </div>
    <div class="table-responsive">
        <table class="recep-table" id="hoy-table">
            <thead>
                <tr>
                    <th>Hora</th>
                    <th>Cliente</th>
                    <th>Mascota</th>
                    <th>Servicio</th>
                    <th>Veterinario</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <div class="field-error" id="hoy-error" style="display:none; margin-top:8px;"></div>
</div>

<script>
(function(){
    const api = {
        vets: "{% url 'usuarios:recep_veterinarios_api' %}",
        servicios: "{% url 'usuarios:recep_servicios_api' %}",
        citas: "{% url 'usuarios:recep_citas_hoy_api' %}",
        estado: (id) => "{% url 'usuarios:recep_cita_estado_api' 0 %}".replace("0", id),
    };
    const vetSel = document.getElementById("hoy-vet");
    const servSel = document.getElementById("hoy-servicio");
    const tbody = document.querySelector("#hoy-table tbody");
    const errEl = document.getElementById("hoy-error");

    function setError(msg="") {
        if (!msg) { errEl.style.display="none"; errEl.textContent=""; return; }
        errEl.textContent = msg; errEl.style.display="block";
    }

    function loadVets() {
        fetch(api.vets).then(r=>r.json()).then(data=>{
            vetSel.innerHTML = "<option value=''>Todos</option>";
            (data.results||[]).forEach(v=>{
                const opt=document.createElement("option");
                opt.value=v.id; opt.textContent=v.nombre;
                vetSel.appendChild(opt);
            });
        });
    }
    function loadServicios() {
        fetch(api.servicios).then(r=>r.json()).then(data=>{
            servSel.innerHTML = "<option value=''>Todos</option>";
            (data.servicios||[]).forEach(s=>{
                const opt=document.createElement("option");
                opt.value=s.id; opt.textContent=s.nombre;
                servSel.appendChild(opt);
            });
        });
    }

    function loadCitas() {
        const params = new URLSearchParams();
        if (vetSel.value) params.append("veterinario_id", vetSel.value);
        if (servSel.value) params.append("servicio_id", servSel.value);
        fetch(`${api.citas}?${params.toString()}`).then(r=>r.json()).then(data=>{
            const citas = data.citas || [];
            tbody.innerHTML = "";
            if (!citas.length) {
                const tr=document.createElement("tr");
                tr.innerHTML = `<td colspan="7" class="muted">Sin citas.</td>`;
                tbody.appendChild(tr);
                return;
            }
            citas.forEach(c=>{
                const tr=document.createElement("tr");
                tr.innerHTML = `
                    <td>${c.hora}</td>
                    <td>${c.cliente}</td>
                    <td>${c.mascota}</td>
                    <td>${c.servicio}</td>
                    <td>${c.veterinario || ""}</td>
                    <td><span class="status-badge">${c.estado}</span></td>
                    <td class="table-actions">
                        <button class="btn-mini" data-estado="pendiente" data-id="${c.id}">Pendiente</button>
                        <button class="btn-mini" data-estado="confirmada" data-id="${c.id}">Espera</button>
                        <button class="btn-mini" data-estado="atendida" data-id="${c.id}">Atendida</button>
                        <button class="btn-mini danger" data-estado="cancelada" data-id="${c.id}">Cancelar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            tbody.querySelectorAll("[data-estado]").forEach(btn=>{
                btn.addEventListener("click", ()=>updateEstado(btn.dataset.id, btn.dataset.estado));
            });
        });
    }

    function updateEstado(id, estado) {
        const motivo = estado === "cancelada" ? "Cancelada por recepcion" : "";
        fetch(api.estado(id), {
            method:"POST",
            headers:{
                "Content-Type":"application/json",
                "X-CSRFToken": (document.cookie.match(/csrftoken=([^;]+)/)||[])[1] || "",
                "X-Requested-With": "XMLHttpRequest",
            },
            body: JSON.stringify({ estado, motivo_cancelacion: motivo }),
        }).then(async r=>{
            const body = await r.text();
            if (!r.ok) { setError(body||"No se pudo actualizar"); return; }
            setError("");
            loadCitas();
        }).catch(()=>setError("Error de red"));
    }

    vetSel.addEventListener("change", loadCitas);
    servSel.addEventListener("change", loadCitas);

    loadVets();
    loadServicios();
    loadCitas();
})();
</script>
