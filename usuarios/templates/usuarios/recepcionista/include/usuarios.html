<div class="card" style="margin-bottom:16px;">
    <div style="margin-bottom:12px;">
        <h2 style="margin:0;">Gestión de usuarios</h2>
        <p style="color:var(--text-muted); margin:4px 0 0;">Listado de clientes registrados.</p>
    </div>
    <form method="get" class="search-bar" data-stay-section="sec-usuarios" style="width:100%; margin-bottom:12px;">
        <input class="input-lite" name="q" value="{{ query }}" placeholder="Buscar por nombre, correo, RUT o mascota">
        <div style="display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;">
            <button class="btn btn-ghost" type="submit">Buscar</button>
            <a class="btn btn-outline" href="?#sec-usuarios">Limpiar</a>
        </div>
    </form>

    <div class="table-responsive" style="margin-top:14px;">
        <table class="recep-table">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>RUT</th>
                    <th>Correo</th>
                    <th>Teléfono</th>
                    <th>Mascotas</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody>
                {% for cliente in clientes_page %}
                    {% with user=cliente.perfil.user %}
                    <tr>
                        <td>{{ user.get_full_name|default:user.username }}</td>
                        <td>{{ cliente.rut }}</td>
                        <td>{{ user.email }}</td>
                        <td>{{ cliente.telefono|default:"-" }}</td>
                        <td>
                            {% if cliente.mascotas.all %}
                                <div class="tag-list">
                                    {% for mascota in cliente.mascotas.all %}
                                        <span class="tag">{{ mascota.nombre }}</span>
                                    {% empty %}
                                        <span class="tag">Sin mascotas</span>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <span class="tag">Sin mascotas</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn-small btn-primary-lite js-open-cliente" type="button" data-target="modal-cliente-{{ cliente.id }}">Gestionar</button>
                        </td>
                    </tr>
                    {% endwith %}
                {% empty %}
                    <tr>
                        <td colspan="6" style="color:var(--text-muted); text-align:center; padding:14px 0;">No hay clientes registrados.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="paginator">
        <div>
            {% if clientes_page.has_other_pages %}
                Página {{ clientes_page.number }} de {{ clientes_page.paginator.num_pages }} ({{ clientes_page.paginator.count }} clientes)
            {% else %}
                {{ clientes_page.paginator.count }} clientes
            {% endif %}
        </div>
        <div class="pager-actions">
            {% if clientes_page.has_previous %}
                <a class="btn-small btn-ghost" href="?page={{ clientes_page.previous_page_number }}{% if query %}&q={{ query }}{% endif %}#sec-usuarios">&laquo; Anterior</a>
            {% else %}
                <button class="btn-small btn-ghost" type="button" disabled>&laquo; Anterior</button>
            {% endif %}
            {% if clientes_page.has_next %}
                <a class="btn-small btn-ghost" href="?page={{ clientes_page.next_page_number }}{% if query %}&q={{ query }}{% endif %}#sec-usuarios">Siguiente &raquo;</a>
            {% else %}
                <button class="btn-small btn-ghost" type="button" disabled>Siguiente &raquo;</button>
            {% endif %}
        </div>
    </div>
</div>

{% for cliente in clientes_page %}
    {% with user=cliente.perfil.user %}
    <div class="modal-overlay" id="modal-cliente-{{ cliente.id }}" data-modal="cliente-{{ cliente.id }}">
        <div class="modal-card">
            <div class="modal-header">
                <div>
                    <div class="pill">Cliente</div>
                    <h3 style="margin:6px 0 0;">{{ user.get_full_name|default:user.username }}</h3>
                    <p style="color:var(--text-muted); margin:4px 0 0;">Rut: {{ cliente.rut }} · {{ user.email }} · {{ cliente.telefono|default:"-" }}</p>
                </div>
                <button class="btn btn-outline js-close-modal" type="button">&times;</button>
            </div>

            <div class="modal-body">
                <div class="card" style="padding:14px;">
                    <h4 style="margin:0 0 8px;">Datos personales</h4>
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap:8px; color:var(--text-muted);">
                        <span>Correo: <strong>{{ user.email }}</strong></span>
                        <span>Teléfono: <strong>{{ cliente.telefono|default:"-" }}</strong></span>
                        <span>Dirección: <strong>{{ cliente.direccion|default:"-" }}</strong></span>
                    </div>
                </div>

                <div class="card" style="padding:14px;">
                    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                        <h4 style="margin:0;">Mascotas</h4>
                    </div>
                    <div class="table-responsive" style="margin-top:10px;">
                        <table class="recep-table compact">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Especie</th>
                                    <th>Sexo</th>
                                    <th>Señas</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for mascota in cliente.mascotas.all %}
                                <tr>
                                    <td>{{ mascota.nombre }}</td>
                                    <td>{{ mascota.get_tipo_display }}</td>
                                    <td>{{ mascota.get_sexo_display }}</td>
                                    <td>{{ mascota.senas_particulares|default:"-" }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" style="color:var(--text-muted); text-align:center;">Sin mascotas registradas.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card" style="padding:14px;">
                    <h4 style="margin:0 0 8px;">Acciones rápidas</h4>
                    <div class="quick-actions">
                        <button class="btn-small btn-primary-lite" type="button">Agendar cita</button>
                        <button class="btn-small btn-ghost" type="button">Reagendar</button>
                        <button class="btn-small btn-ghost" type="button">Ver historial de citas</button>
                        <button class="btn-small btn-ghost" type="button">Ver expediente</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endwith %}
{% endfor %}

<script>
document.addEventListener("DOMContentLoaded", () => {
    const openButtons = document.querySelectorAll('.js-open-cliente');
    const modals = document.querySelectorAll('.modal-overlay');
    const searchForm = document.querySelector('form[data-stay-section]');

    function openModal(targetId) {
        const modal = document.getElementById(targetId);
        if (modal) modal.classList.add('is-open');
    }
    function closeModal(modal) {
        modal.classList.remove('is-open');
    }

    openButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const target = btn.dataset.target;
            if (target) openModal(target);
        });
    });

    modals.forEach(modal => {
        const closeButtons = modal.querySelectorAll('.js-close-modal');
        closeButtons.forEach(btn => btn.addEventListener('click', () => closeModal(modal)));
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal(modal);
        });
    });

    if (searchForm) {
        searchForm.addEventListener('submit', () => {
            const hash = '#'+(searchForm.dataset.staySection || 'sec-usuarios');
            if (!searchForm.action.includes('#')) {
                searchForm.action = (searchForm.action || '') + hash;
            }
        });
    }
});
</script>
